name: Publish Notebooks to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install jupyter-book pyyaml nbconvert

      - name: Check and setup notebooks directory
        run: |
          # Ensure notebooks directory exists
          mkdir -p notebooks
          
          # Check for notebooks
          notebook_count=$(find notebooks -maxdepth 1 -name "*.ipynb" -not -name ".*" 2>/dev/null | wc -l)
          echo "Found $notebook_count notebook(s)"
          
          if [ "$notebook_count" -eq 0 ]; then
            echo "WARNING: No notebooks found. Creating a sample notebook..."
            cat > notebooks/sample.ipynb << 'NOTEBOOK_EOF'
          {
           "cells": [
            {
             "cell_type": "markdown",
             "metadata": {},
             "source": [
              "# Sample Notebook\n",
              "\n",
              "This is a placeholder. Replace with your actual Databricks notebooks."
             ]
            },
            {
             "cell_type": "code",
             "execution_count": null,
             "metadata": {},
             "outputs": [],
             "source": [
              "print('Hello from Databricks!')\n",
              "print('Add your notebooks to the notebooks/ directory')"
             ]
            }
           ],
           "metadata": {
            "kernelspec": {
             "display_name": "Python 3",
             "language": "python",
             "name": "python3"
            },
            "language_info": {
             "name": "python",
             "version": "3.10.0"
            }
           },
           "nbformat": 4,
           "nbformat_minor": 4
          }
          NOTEBOOK_EOF
          fi
          
          # List what we have
          echo "Notebooks directory contents:"
          ls -lah notebooks/

      - name: Create Jupyter Book configuration
        run: |
          # Create _config.yml
          cat > notebooks/_config.yml << 'CONFIG_EOF'
          title: Databricks Notebooks
          author: Data Team
          logo: ""
          
          # Execution settings
          execute:
            execute_notebooks: 'off'
            cache: ""
            timeout: 600
            allow_errors: true
          
          # Parse settings
          parse:
            myst_enable_extensions:
              - colon_fence
              - dollarmath
              - linkify
          
          # HTML settings
          html:
            use_repository_button: true
            use_issues_button: false
            use_multitoc_numbering: false
            home_page_in_navbar: true
          
          # Repository settings  
          repository:
            url: https://github.com/${{ github.repository }}
            path_to_book: notebooks
            branch: main
          
          # Sphinx settings
          sphinx:
            config:
              html_theme: sphinx_book_theme
              html_show_copyright: false
          CONFIG_EOF
          
          echo "Created _config.yml"

      - name: Create index page
        run: |
          cat > notebooks/index.md << 'INDEX_EOF'
          # Databricks Notebooks
          
          Welcome to our collection of Databricks notebooks published via GitHub Pages.
          
          ## Navigation
          
          Use the sidebar to browse available notebooks.
          
          ## About
          
          These notebooks are automatically published from our Databricks workspace using Jupyter Book and GitHub Actions.
          
          ---
          
          *Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          INDEX_EOF
          
          echo "Created index.md"

      - name: Generate table of contents
        run: |
          python3 << 'PYTHON_EOF'
          import yaml
          from pathlib import Path
          
          notebooks_dir = Path('notebooks')
          
          # Find all notebooks (exclude hidden files and index)
          notebooks = sorted([
              f.stem for f in notebooks_dir.glob('*.ipynb')
              if not f.name.startswith(('.', '_')) and f.stem != 'index'
          ])
          
          print(f"Generating TOC with {len(notebooks)} notebook(s):")
          for nb in notebooks:
              print(f"  • {nb}")
          
          # Create table of contents
          if notebooks:
              toc_data = {
                  'format': 'jb-book',
                  'root': 'index',
                  'chapters': [{'file': nb} for nb in notebooks]
              }
          else:
              # Minimal TOC with just the index
              toc_data = {
                  'format': 'jb-book', 
                  'root': 'index'
              }
          
          # Write TOC file
          toc_file = notebooks_dir / '_toc.yml'
          with open(toc_file, 'w') as f:
              yaml.dump(toc_data, f, default_flow_style=False, sort_keys=False)
          
          print(f"\nWrote {toc_file}")
          print("Contents:")
          print(toc_file.read_text())
          PYTHON_EOF

      - name: Validate structure
        run: |
          echo "Validating Jupyter Book structure..."
          
          # Check required files
          for file in notebooks/_config.yml notebooks/_toc.yml notebooks/index.md; do
            if [ -f "$file" ]; then
              echo "✓ $file"
            else
              echo "✗ Missing: $file"
              exit 1
            fi
          done
          
          echo ""
          echo "Structure validation passed!"

      - name: Build Jupyter Book
        run: |
          echo "Building Jupyter Book..."
          echo ""
          
          # Build (remove --verbose and --all flags for compatibility)
          jupyter-book build notebooks 2>&1 | tee build.log
          
          build_status=${PIPESTATUS[0]}
          echo ""
          echo "Build exit status: $build_status"
          
          if [ $build_status -ne 0 ]; then
            echo "ERROR: Jupyter Book build failed!"
            echo "=== Build Log ==="
            cat build.log
            exit 1
          fi
          
          echo "✓ Build completed successfully"

      - name: Verify build output exists
        run: |
          echo "Verifying build output..."
          
          # Check for build directory
          if [ ! -d "notebooks/_build" ]; then
            echo "ERROR: _build directory not created"
            exit 1
          fi
          
          # Check for html output
          if [ ! -d "notebooks/_build/html" ]; then
            echo "ERROR: _build/html directory not created"
            echo "Directory structure:"
            find notebooks/_build -type d
            exit 1
          fi
          
          # Check for index.html
          if [ ! -f "notebooks/_build/html/index.html" ]; then
            echo "ERROR: index.html not generated"
            echo "HTML directory contents:"
            ls -la notebooks/_build/html/
            exit 1
          fi
          
          echo "✓ Build output verified"
          echo ""
          echo "Generated files:"
          ls -lah notebooks/_build/html/ | head -20

      - name: Prepare deployment
        run: |
          echo "Preparing site for deployment..."
          
          # Create _site directory
          mkdir -p _site
          
          # Copy built HTML
          cp -r notebooks/_build/html/* _site/
          
          # Verify
          if [ ! -f "_site/index.html" ]; then
            echo "ERROR: Failed to copy files to _site"
            exit 1
          fi
          
          echo "✓ Deployment preparation complete"
          echo ""
          echo "Site contents:"
          ls -lah _site/ | head -20

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
